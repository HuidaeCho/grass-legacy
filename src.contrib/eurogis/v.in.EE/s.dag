# ******************************************************************
# IN:	pide	Fichero (con categorias, tags)  en formato dado por
#		genamap (r2ex).
# Para lineas y puntos

# OUT:	pide	Fichero en formato GRASS.
#	  "	Fichero GRASS de categorias.
# ******************************************************************

# *** Cambiar el origen al directorio de interes.
origen=/home/deltam/csn2/ZF25

echo " *****  El fichero exportado esta en $origen"
echo "Nombre del fichero exportado en genamap con r2ex:"
read nomdelta
entrada=$origen/$nomdelta.EE

if test -s $entrada
then

# *** Cambiar el destino al directorio de interes.
destino=/home/grass4/data/graus/graus

programa=/home1/csn2
cd $programa
echo " *****  El mapa GRASS se crea en $destino"
echo "Nombre del mapa GRASS que se va a crear:"
read nomgrass
salida1=$nomgrass
salida2=$nomgrass.2

if test -s $destino/dig_ascii/$salida1
then
	echo "$destino/dig_ascii/$salida1"
	echo " **** FICHERO YA CREADO  "
	echo " **** ANTES EJECUTAR:  u.rm $1  "
else
awk '
{
if(substr($1,length($1)-3,4)=="EDGE"){
	print "A",$2 >> "'$salida1'"
	print $1,$2," *** ","A",$2
	}
else
if(substr($1,length($1)-3,4)=="LINE"){
	veces = 0
	categ = $2
	ptos = $3
	print "L",ptos >> "'$salida1'"
	print $1,$3," *** ","L",$3
	}
  else
if(substr($1,length($1)-4,5)=="POINT"){
	llave=1
	categ = $2
	ptos = $3
	print "P",ptos >> "'$salida1'"
	print $1,$3," *** ","P",$3
}
else
	{
	veces++
	X=$1
	Y=$2
	printf "%13.2f%13.2f\n",Y,X >> "'$salida1'"

	if ((veces == 1) && (ptos == 2)) {
		x1 = X
		y1 = Y
	}

	if (llave == 1) {
		printf "P%15.2f%15.2f%7d\n",X,Y,categ >> "'$salida2'"
		llave=0
	}

	if ((veces == 2) && (ptos != 2))
		printf "L%15.2f%15.2f%7d\n",X,Y,categ >> "'$salida2'"
  	if ((veces == 2) && (ptos == 2)) {
		xm = (X + x1) / 2	
		ym = (Y + y1) / 2	
		printf "L%15.2f%15.2f%7d\n",xm,ym,categ >> "'$salida2'"
	}
	}
}
' $entrada

#*******************mv $entrada $entrada.+
cat x.cab $salida1 > $salida1.cab
mv $salida1.cab $salida1
# chown grass4 $salida1
# chown grass4 $salida2
# mv $salida1 $destino/dig_ascii/$salida1
# mv $salida2 $destino/dig_att/$salida1
fi
else
	echo "No existe $entrada"
fi
