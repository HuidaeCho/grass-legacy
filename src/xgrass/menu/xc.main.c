#define MAIN
#include "xc.xclip.h"
#include "xgrass.h"
#include <setjmp.h>

#define xclip_width 64
#define xclip_height 64
static char xclip_bits[] = {
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x0f, 0xe4, 0xcf, 0x3f, 0xf8, 0xf1, 0x9f, 0xff,
   0x0f, 0x72, 0x8e, 0x71, 0xdc, 0x19, 0xde, 0xf0, 0x1e, 0x71, 0x9c, 0x71,
   0xc6, 0x19, 0xd8, 0xc0, 0x3c, 0x31, 0x80, 0x71, 0xc6, 0x19, 0xc0, 0x00,
   0xb8, 0x30, 0x80, 0x3f, 0xfe, 0xf9, 0xcf, 0x7f, 0x58, 0xb0, 0x87, 0x03,
   0xce, 0xf1, 0x9f, 0xff, 0xe8, 0x30, 0x8f, 0x0d, 0xc6, 0x01, 0x1c, 0xe0,
   0xe4, 0x31, 0x9e, 0x1d, 0xc6, 0x01, 0x1c, 0xe0, 0xc4, 0x73, 0x9c, 0x39,
   0xc6, 0x19, 0xdc, 0xe0, 0xc2, 0x73, 0x9c, 0x39, 0xc6, 0x39, 0xdc, 0xe1,
   0x81, 0xe7, 0xcf, 0x73, 0xef, 0xfb, 0xcf, 0x7f, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0xe0, 0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x41, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0xc0, 0x23, 0xc0, 0xff, 0x01, 0x00, 0x00, 0x00,
   0x80, 0x27, 0xc0, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x17, 0xc0, 0xff,
   0x01, 0x00, 0x00, 0x00, 0x00, 0x0b, 0xc0, 0xdd, 0x01, 0x00, 0x00, 0x00,
   0x00, 0x1d, 0xc0, 0xdd, 0x01, 0xfc, 0x01, 0x00, 0x80, 0x3c, 0xc0, 0xdd,
   0xe1, 0xff, 0x03, 0x00, 0x80, 0x78, 0xc0, 0xff, 0xe1, 0xff, 0xff, 0x00,
   0x40, 0x78, 0xc0, 0xf7, 0x01, 0xfc, 0x83, 0x03, 0x20, 0xf0, 0xc0, 0xf7,
   0xc1, 0xff, 0x01, 0x06, 0x00, 0x00, 0xc0, 0xff, 0x01, 0xfc, 0x00, 0x08,
   0x80, 0x3f, 0xc0, 0xff, 0x01, 0x00, 0x00, 0x08, 0xc0, 0x38, 0xc0, 0xff,
   0x01, 0x00, 0x00, 0x08, 0x40, 0x70, 0xc0, 0xff, 0x01, 0x00, 0x00, 0x10,
   0x40, 0x00, 0xc0, 0xff, 0x01, 0x00, 0x00, 0x10, 0x40, 0x00, 0xc0, 0xdd,
   0x01, 0x00, 0x00, 0x10, 0xc0, 0x70, 0xc0, 0xdd, 0x01, 0x00, 0x00, 0x10,
   0xc0, 0x38, 0xc0, 0xdd, 0x01, 0x00, 0x00, 0x10, 0x80, 0x3f, 0xc0, 0xff,
   0x01, 0x00, 0x00, 0x18, 0x00, 0x00, 0xc0, 0xf7, 0x01, 0x00, 0x00, 0x08,
   0xc0, 0x01, 0xc0, 0xf7, 0x01, 0x00, 0x00, 0x08, 0x80, 0x00, 0xc0, 0xff,
   0x01, 0x00, 0x00, 0x04, 0x80, 0x00, 0xc0, 0xff, 0x01, 0x00, 0x00, 0x06,
   0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00,
   0x00, 0x00, 0xfc, 0x00, 0x80, 0x70, 0x00, 0x00, 0x00, 0xc0, 0x03, 0x00,
   0x80, 0x38, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0xc0, 0x3f, 0x00, 0x00,
   0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00,
   0x80, 0x0f, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00,
   0x00, 0x18, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00,
   0x00, 0x02, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00,
   0x00, 0x80, 0x01, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00,
   0x00, 0x06, 0x38, 0x00, 0x00, 0x00, 0x02, 0x00, 0x80, 0x0f, 0xc0, 0x03,
   0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x00, 0xe0, 0x01, 0x00,
   0xc0, 0x3f, 0x00, 0x00, 0xff, 0x1f, 0x00, 0x00, 0x80, 0x70, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x80, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x3f, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x01, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};


XclipGlobalData *zzGlobal;
extern char *strtok();
jmp_buf backHere;

XClip(argc,argv,appContext,display,applShell,standAlone)
    unsigned argc;
    char **argv;
    XtAppContext appContext;
    Display *display;
    Widget applShell;
    Boolean standAlone;
{
    char *cppflags = NULL;
    char cmd[80];
    extern FILE *zzin;
    Widget shell;
    Atom protocol;
    Pixmap xclip_icon;
    XclipGlobalData *Global;

    if (standAlone) {
	/* start signal handling */
	signal(SIGKILL,XCInterrupt);
	signal(SIGHUP,XCInterrupt);
	signal(SIGINT,XCInterrupt);
	signal(SIGQUIT,XCInterrupt);
    }

    /* set some global values */
    Global = zzGlobal = (XclipGlobalData *) _XgMalloc(sizeof(XclipGlobalData));
    Global->progName = (NULL != (Global->progName = G_rindex(argv[0],'/'))) ?
                      ++Global->progName:*argv;
    Global->scriptFile = NULL;

    Global->appContext = appContext;
    Global->display = display;

    Global->applShell = applShell;
    Global->standAlone = standAlone;

    if (!standAlone) {
      if (setjmp(backHere)) {
	return 0;
      }
    }

    /* now the parse the rest of the command line */
    commandDefaults = False;
    cppflags = XCParseCommand(argc,argv,Global);
    
    /* set lex input scriptFile to return from cpp or open the file */
    if ( !strcmp(Global->scriptFile,"stdin") )  {
        if ( cppflags == NULL ) 
            sprintf(cmd,"/lib/cpp -P");
        else
            sprintf(cmd,"/lib/cpp -P %s",cppflags);
    } else { 
        if ( cppflags == NULL ) 
            sprintf(cmd,"/lib/cpp -P %s",Global->scriptFile);
        else
            sprintf(cmd,"/lib/cpp -P %s %s",cppflags,Global->scriptFile);
    }

    if ((zzin = popen(cmd,"r")) == NULL ) {
        sprintf(errorbuf,"Can't open %s",Global->scriptFile);
        XCFatalError("running C preprocessor",errorbuf);
    }

    /* parse the script, and get ptr to the internal representation */
    zzinitParser();
    if ( zzparse() && standAlone ) exit(1);

    shell = Global->applShell;
    protocol = XmInternAtom(XtDisplay(shell), "WM_DELETE_WINDOW", False);
    XmAddWMProtocols(shell, &protocol, 1);
    XtAddEventHandler(shell, NoEventMask, True, _XcWMClientMessage, CreateBunch(Global,shell));

    if ( XmIsMotifWMRunning(shell) ) {
        unsigned int decor_flags, func_flags;

        decor_flags = MWM_DECOR_BORDER | MWM_DECOR_RESIZEH;
        decor_flags |= MWM_DECOR_TITLE | MWM_DECOR_MENU;
        decor_flags |= MWM_DECOR_MINIMIZE;

        func_flags = MWM_FUNC_CLOSE | MWM_FUNC_RESIZE;
        func_flags |= MWM_FUNC_MOVE | MWM_FUNC_MINIMIZE;

        XtVaSetValues(shell,
            XmNmwmDecorations, decor_flags,
            XmNmwmFunctions, func_flags,
            NULL);
    }

    Global->scrptr = XtScreen(Global->applShell);
    Global->screen = DefaultScreen(Global->display);
    Global->cmap = DefaultColormap(Global->display, Global->screen);
    
    /* assign comand line defaults into flag and parm data structures */
    if ( commandDefaults )
        AssignComDefs(Global);

    if ( Global->captureSet ) {
        if ( Global->capture ) {
            Global->_xc_Data.capture = True;
        } else {
            Global->_xc_Data.capture = False;
        }
    }


    CreateInterface(Global);


    return 1;
}

struct Bunch *CreateBunch(g,d)
XclipGlobalData *g;
void *d;
{
  struct Bunch *b;
  b = (struct Bunch *) _XgMalloc(sizeof(struct Bunch));
  b->theGlobal = g;
  b->data = d;
  return b;
}

MakeArgValues(s,c,v)
char *s;
int *c;
char ***v;
{
  int argc;
  char **argv;
  char *t;
  
  argv = (char **) _XgMalloc(50*sizeof(char *));
  argv[0] = _XgStrDup("xclip");
  argc = 1;
  t = strtok(s," ");
  argv[argc++] = _XgStrDup(t);
  while (t) {
    t = strtok(NULL," ");
    if (t)
      argv[argc++] = _XgStrDup(t);
  }
  argv[argc] = NULL;
  *c = argc;
  *v = argv;
}

