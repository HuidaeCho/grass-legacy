.\" %W% %G%
.TH watershed 1
.SH NAME
watershed \- Menu-driven user interface for running
watershed analysis steps
.br
.I (GRASS Tool)
.SH SYNOPSIS
.B watershed
.SH DESCRIPTION
The \fIwatershed\fR program is an interface to routines which perform
various steps related to completing a watershed analysis.

For the purpose of completing all steps of the
process with a minimum of input required at 
each step, and in order to maintain a record of
all parameters used to obtain a particular
result, a "project" file is created to hold
information pertaining to 
.CT "map layer" "cell map"
names and
input parameter values.
Upon entry of the \fIwatershed\fR program, the user
will first see the following:
.nf


         WELCOME TO THE WATERSHED SOFTWARE SYSTEM
                                                                               
  This program is designed to help you follow the correct                      
  steps to obtain a GRASS cell map depicting watershed                      
  geometry using an elevation cell map (with true elevation                  
  values) as a starting point.  All steps are recorded                         
  under the project name.


                                                                               
  Choose desired option:                                                       
                                                                               
  1.  Create new project                                                       
  2.  Create new project based on currently existing project                   
  3.  Work on an existing project                                              

  4.  Remove old files
                                                                               
.fi

The user can exit from the program after completing
any number of steps. Hence, the option to "Work
on an existing project" allows for finishing any
remaining steps, or for redoing particular steps,
or both.

A new project may be created with all new inputs,
or a new project can be created using inputs
from a previous project.

The option to remove old files should be used to remove only
miscellaneous files created as part of the \fBwatershed\fR
program.  All 
.CT "map layers (cell files)" "cell maps"
created using this program
should be removed in the usual way using command \fIGremove[2G]\fR.
The files which can be removed using option 4 above include those
storing pit points and the miscellaneous file storing nodes
information created as part of the step to code stream segments.
These files should not be removed until the analysis of which
they are a part is finished and over.  An option is also
provided to remove project files.  Again, since this is a file
which stores information to complete the project and which tells
of the input parameters used to create a particular product,
this should also not be removed prematurely.  See the rest of
this document for further explanation of these files and their
usage.

Once an old or new project has been chosen,
the user will be presented the following menu and
allowed to choose an option:

.nf
1.  Filtering elevation cell map                                              
2.  Locating pits                                                            
3.  Calculating drainage accumulation/outlining watershed                      
4.  Creating stream network                                                    
5.  Coding stream segments/finding segment lengths                             
6.  Finding subwatershed basins                                                
                                                                               
7.  Quit
.fi

The steps are presented in the order they should be used to
complete the total watershed analysis for the purpose of
creating all products.  While input is being accepted for
each individual step, the option is given whether to
run the actual program.  If the program has been run
and completed without error, the word "COMPLETE" will
appear on the above menu after the listing of that
step.

It is not required that
all the steps be completed, or that they be run in this
particular order, except where products from one step are
required for another.
Steps 1 and 2 can be used apart from the rest of 
the steps in the menu.  In order to complete all
six steps, all parts must be completed, with the
exception of step number 1 (unfiltered data may be
used for steps 2 and 3, but time requirements will be
affected -- see explanations below).

.SH 1.  FILTERING
This function smoothes elevation 
.CT data "cell map"
using a particular
filter for the purpose of decreasing significantly
the number of pits found, eliminating many pits which
are glitches in the 
.CT data "cell map"
instead of true pits.

Any 
.CT data "cell map"
can be filtered with this program, but for
the purposes of watershed analysis, the input 
.CT layer "cell map"
must contain true elevation values.
The user is asked for the input 
.CT "layer," "cell map,"
an output 
.CT layer "cell map"
name, and the desired
number of filter iterations.  It is normally sufficient
to filter the 
.CT data "cell map"
once.  Some pit points will
remain, but these are probably true pits.  The filtering
is done on 3x3 neighborhoods, using a weighted averaging
technique.
The filtering is done only on the input values, not on rows
already averaged during the filtering process.
.SH NOTES
The current 
.CT "" geographic
window setting is ignored.  Instead,
the 
.CT "" geographic
window for the entire input 
.CT "map layer" "cell map"
is used.

For the purposes of completing all the steps of the
watershed analysis, this is the only optional step.
If filtering of the elevation 
.CT data "cell map"
is not done, it is
likely that an abundance of pits will be found, and execution
of the next couple of steps will be time consuming.

.SH 2.  LOCATING PITS
This step 
generates a list of pit points designated by their
.XT grid 
cell coordinates.
Pits are points which are characterized as
having an elevation value which is less than or equal
to that of all neighboring points.
Input to this program should be a cell 
.CT file map
containing
true elevation values. It is usually helpful to
filter the elevation 
.CT file "cell map"
first  (see "FILTERING" above).
The pit points are sorted by decreasing elevation value, and
stored in a miscellaneous file under the current location
and mapset.
.SH NOTES
The current 
.CT "" geographic
window setting is ignored.  Instead,
the 
.CT "" geographic
window for the entire input (elevation) 
.CT "map layer" "cell map"
is used.

For the purposes of completing all the steps of the
watershed analysis, pit points are used to begin the
process of identifying depression areas and possible
lakes.

.SH 3.  CALCULATING DRAINAGE ACCUMULATION
This step
generates a drainage accumulation 
.CT "map layer" "cell map"
from elevation
.CT "data." "cell map."
Drainage accumulation is designated by 
assigning each cell a category value equivalent
to the number of cells within the designated
watershed that drain into that cell. An implied watershed
boundary is generated, as all cells outside the
watershed have category value zero (no data).
Also generated are an adjusted
drainage direction 
.CT "" cell
map (adjusted to allow for the draining
of water across lakes), and an optional product which denotes
designated lakes, pits, and redirected routes. 

The elevation 
.CT "map layer" "cell map"
used for input will be that used
in the previous step to find pit points.  Users must supply all
output 
.CT "" cell
map names, the desired watershed outlet point, and
threshold values for slope (what decimal slope value is
considered "flat" for the purposes of including cells in
the watershed basin) and for pit processing (number of meters
to allow for error above the pouring point in making
decisions on cells to include in a lake basin about a
pit point).

It is important that input parameters are chosen with
care for this step in order to produce meaningful results.
Following are some suggested ways to do this choosing.

The
.I watershed outlet
acts as a beginning place for this routine.  The
.CT "grid point" cell
chosen as the outlet is used as the first
cell in the watershed, and then all adjacent cells
are checked for the criteria of 'upslope.'  Recursive
calls are made to a 'hill-climbing' routine each time
an adjacent upslope cell is found.  These recursive
calls continue until the edge of the watershed is
reached.  Thus, the chosen outlet point determines
the accuracy of the product, and attempts should
be made to find a point within a drainage channel.
In order to choose
an outlet point accurately, the user should follow
these recommendations:
1.  use the displaying techniques available in GRASS
to "window in" on the area containing the desired
outlet point (displaying the elevation 
.CT file "cell map"
being used).
2.  use "whereami" techniques within display or
the \fIDwhere\fR command to locate an outlet point in
an area where elevation category changes have sharp
crenulations.

The
.I slope threshold
is used to aid in decisions during the process of
hill-climbing by defining "flatness." When a 
.XT grid
cell's neighbors are being checked for inclusion in
the watershed, the decision is based on whether that
neighbor drains into the current cell in question
(and is therefore considered "upslope"),
or whether the slope magnitude of that neighbor is
sufficiently small to justify traversing it
on the way to finding the watershed boundary (thus
defining "flatness").  This definition of
what is meant by the slope magnitude
being "sufficiently small" is left to the user
through input of the slope threshold.
(Slope in this routine is calculated as a decimal
value using a gradient calculation of the square
root of the sum of the central difference in the
x direction squared plus the central difference
in the y direction squared.)  A
reasonable value for the slope threshold is 
dependent on the terrain in question and the
resolution of the elevation 
.CT data "cell map"
provided.  As a
general rule, the slope threshold should be smaller
for a finer resolution of elevation 
.CT "data," "cell map,"
due to
the fact that finer resolution data generally
implies smaller differences in elevation values
between two 
.XT grid 
cells (again, dependent
on the terrain begin depicted).  The user may
need to experiment with various threshold values
until desired results are obtained, but as a 
suggested starting point, a slope threshold of
about 2/1000 (.002) could be tried for 30 m. data,
and about 2/100 (.02) for 100 m. data.  If, after
running this step with a particular slope threshold,
the resulting 
.CT "map layer" "cell map"
seems to include 
.XT grid 
cells which should not be part of the watershed
in question, the step should be rerun with a smaller
slope threshold.  The choice of a good slope threshold
may be particularly crucial if the watershed outlet
is in a relatively flat area.

As part of this step, "local drainage areas"
(or "lakes") are defined for each pit.  Starting
at a pit point, surrounding 
.XT grid 
cells are 
included in its local drainage area by satisfying
one of two criteria:  either the adjacent cell
drains naturally to the pit point in question,
or it has a slope magnitude of zero AND has an
elevation value equal to that of the adjoining
cell which is already assigned to the drainage
area.  (When assignment occurs due to this second
set of criteria, the assigned cell has its
drainage direction redirected to the adjoining
cell, and thus ultimately towards the pit point.)
Once all cells meeting the criteria have been
included in the drainage area, a "lake area" 
(which may or may not represent an actual lake)
is extracted from it.  The lake area 
is determined by finding the pouring
point of the local drainage area (the cell
along the boundary with the lowest elevation),
and including in the lake only the cells within
the drainage area that have elevation equal to
or lower than the pouring point plus some
error tolerance defined by the user.  This
error tolerance is what is input as the
.I pit threshold.
In general, it also holds true here that the
finer the resolution of the data, the smaller
the value of the needed pit threshold.  For
30 m. data, a reasonable pit threshold value
is 5 m., and for 100 m. data, a pit threshold
of 10 m. or more is probably needed.  This
threshold may also need to be adjusted 
according to the type of terrain being 
depicted.  Depiction of lake areas is
important with respect to the fact that
the included cells will have their drainage
direction pointers redirected.

In order to obtain the desired results, the
user may need to experiment with various
combinations of inputs.  It is essential
that the drainage accumulation output
.CT "map layer" "cell map"
contain meaningful data before
its use in the next step, so the
user should check the results using display
before continuing.  (A quick preliminary
check for meaningful results can be done using
Gdescribe on the output 
.CT "map layer." "cell map."
If Gdescribe
gives the 
.CT "" category
values of the output 
.CT "map layer" "cell map"
as
all small, then the results are not meaningful
unless the user desires a very small watershed
to be defined.  The size of the 
.CT "" category
values in the
output 
.CT layer "cell map"
are directly related to the size
of the watershed depicted.)
.SH NOTES
The pit processing step must be completed before this
step.

The current 
.CT "" geographic
window setting is used.  The user should
take care that the desired watershed is within the current
.CT "" geographic
window if possible.  (The watershed boundary may extend
beyond the edge of available elevation input 
.CT "data.)" "cell map.)"

.SH 4.  CREATING STREAM NETWORK
This step
generates a stream network 
.CT "map layer" "cell map"
from a drainage
accumulation input 
.CT "layer." "cell map."
User must supply an
.I accumulation threshold
(number of cells that must drain into a given cell
before that cell is saved as part of the stream
network) as well as the desired number of thinning
iterations.  The accumulation threshold will determine
the density of the tributaries in the resulting stream
network.  The smaller the threshold, the more tributaries
in the result.  All cells within the input 
.CT layer "cell map"
which have
category values less than the threshold will be eliminated.
(Please note that if the results of step 3 are not 
meaningful, it will be impossible to obtain a stream
network product here.)  The threshold value should
be chosen based on the 
.CT "" category
values in the input 
.CT "map layer," "cell map,"
and on the desired tributary density; but a
reasonable threshold estimate for 30 m. data would
be 60 or 70.  (An equivalent threshold for 100 m. 
data would be smaller.)
If the resulting stream network is to be used to
complete the rest of the steps of this interface,
it is essential that thinning be done
to one 
.CT pixel cell
width.
The user should begin by using a fairly
small number of thinning iterations (3 to 5), and rerun
this step with a higher number of iterations if
the results do not meet this criteria.
(Display should be used to check the output.)
If large "widened" or lake-like areas remain in
the output 
.CT "map layer" "cell map"
after a fairly high number
of iterations, the user should use a 
higher threshold value.
.SH NOTES
The current 
.CT "" geographic
window setting is ignored.  Instead,
the 
.CT "" geographic
window for the entire input 
.CT "map layer" "cell map"
is used.

.SH 5.  CODING STREAM SEGMENTS
This step
generates a stream network which is coded by stream
segment given a zero-one input 
.CT layer "cell map"
of a one 
.CT pixel cell
width stream network generated through the
steps in this menu.  At each branching
of the original network, a new category 
.CT number value
is assigned.
Thus, the resulting network has each channel segment denoted by
a unique category 
.CT "number." "value."
This numbering will correspond with
the numbering of subbasins within the given watershed.
The resulting 
.CT "map layer" "cell map"
is an optional product.  Please note
that this step will not complete if the input streams 
.CT "" cell
map
has not been thinned to one 
.CT pixel cell
width.

A miscellaneous file is also created which contains
the nodes (beginning and ending points) for each segment, as
well as the length of each segment.  This output file
is needed for the running of the next step.
.SH NOTES
The current 
.CT "" geographic
window setting is ignored.  Instead,
the 
.CT "" geographic
window for the entire input 
.CT "map layer" "cell map"
is used.

This step needs a zero-one 
.CT "map layer" "cell map"
as input.
However, the output 
.CT "map layer" "cell map"
(if requested) will have as many categories as
there are channel segments in the network representation.

.SH 6.  FINDING SUBWATERSHED BASINS
This final step in the process
generates an output 
.CT layer "cell map"
containing a unique category 
.CT number value
and area for each subbasin within a given watershed and for
a given stream network.  This must be run as part of
the series of steps from this menu, and needs an input 
.CT "map layer" "cell map"
of adjusted drainage directions (from step 3)
and the name of the thinned stream network used as input
to step number 5.  Thus, steps 2 through 5 must be
completed before this program can be run.
.SH NOTES
The current 
.CT "" geographic
window setting is ignored.  Instead,
the 
.CT "" geographic
window for the entire stream network 
.CT "map layer" "cell map"
is used.

Number of categories in the output 
.CT layer "cell map"
is equivalent to the number of channel segments
in the stream network.
.SH BUGS
Results of this step may not be completely accurate.
Problems are
due to routing of water over lakes and flat areas,
as well as problems with the thinning routine.  To create
a product using alternate means, see Appendix A of
the \fIGRASS Tutorial: watershed\fR.
.SH "AUTHORS"
Marjorie Larson, U.S. Army Construction Engineering Research Laboratory
.br
Larry Band, Dept. of Geography, University of Toronto
